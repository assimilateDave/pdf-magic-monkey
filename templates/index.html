<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document OCR Review</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        html, body { height: 100%; margin: 0; }
        .container-fluid, .row, #main-vert { height: 90vh; }
        #main-vert {
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 400px;
        }
        #top-panel, #bottom-panel { min-height: 100px; }
        #top-panel { height: 50%; overflow-y: auto; padding: 10px; }
        #bottom-panel { height: 50%; overflow-y: auto; padding: 10px; border-top: 1px solid #ddd; }
        #h-resizer {
            height: 8px;
            background: #bbb;
            cursor: row-resize;
            width: 100%;
            z-index: 10;
        }
        #ocr-text { white-space: pre-wrap; background: #f9f9f9; border: 1px solid #eee; padding: 8px; min-height: 120px; }
        .search-highlight { background-color: #ffff99; font-weight: bold; }
        .search-controls { margin-bottom: 10px; }
        .search-stats { font-size: 0.9em; color: #666; margin-left: 10px; }
        #pdf-viewer { width: 100%; height: 60vh; min-height: 200px; border: 2px solid #007bff; background: #fff; display: block; }
        #pdf-container { min-height: 220px; }
        #pdf-missing { color: #c00; font-weight: bold; }
        #doc-list { max-height: 60vh; overflow-y: auto; }
        .doc-entry { cursor: pointer; }
        .doc-entry.selected { background: #e6f7ff; }
    </style>
</head>
<body>
<div class="container-fluid">
    <h2 class="mt-3 mb-3">Document OCR Validation</h2>
    <div class="row">
        <div class="col-md-3">
            <h5>Processed Documents</h5>
            <ul id="doc-list" class="list-group"></ul>
        </div>
        <div class="col-md-9">
            <div id="main-vert">
                <div id="top-panel">
                    <h5 id="selected-filename">(Select a document)</h5>
                    <strong>Extracted Text:</strong>
                    <div class="search-controls">
                        <div class="input-group input-group-sm">
                            <input type="text" id="search-input" class="form-control" placeholder="Search in extracted text..." style="max-width: 300px;">
                            <button class="btn btn-outline-secondary" type="button" id="clear-search" title="Clear search">
                                <span>&times;</span>
                            </button>
                        </div>
                        <span id="search-stats" class="search-stats"></span>
                    </div>
                    <div id="ocr-text">(none)</div>
                    <div class="my-3">
                        <button id="flag-btn" class="btn btn-warning" style="display:none;">Flag for Reprocessing</button>
                        <span id="flagged-label" class="badge bg-danger" style="display:none;">Flagged for Reprocessing</span>
                    </div>
                </div>
                <div id="h-resizer"></div>
                <div id="bottom-panel">
                    <strong>Original PDF:</strong>
                    <div id="pdf-container">
                        <!-- Always render iframe and missing message divs -->
                        <iframe id="pdf-viewer" src="" frameborder="0"></iframe>
                        <div id="pdf-missing" style="display:none;">[No PDF available]</div>
                        <div id="pdf-placeholder" style="color:#888;">Select a PDF document to view.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
let docListCache = [];
let selectedFilename = null;
let selectedBasename = null;
let originalTextContent = null;

function fetchDocuments(selectFirst = false) {
    fetch('/api/documents')
        .then(resp => resp.json())
        .then(docs => {
            docListCache = docs;
            let docList = document.getElementById('doc-list');
            docList.innerHTML = '';
            for (let i = 0; i < docs.length; i++) {
                let doc = docs[i];
                let li = document.createElement('li');
                li.className = 'list-group-item doc-entry';
                if (doc.flagged) li.classList.add('list-group-item-danger');
                li.textContent = doc.filename + (doc.flagged ? " (FLAGGED)" : "");
                li.dataset.filename = doc.filename;
                li.dataset.basename = doc.basename;
                li.onclick = function() {
                    document.querySelectorAll('.doc-entry').forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    loadDocumentDetail(doc.filename, doc.basename);
                };
                docList.appendChild(li);
            }
            if (selectFirst && docs.length > 0) {
                docList.firstChild.click();
            }
        });
}

function loadDocumentDetail(filename, basename) {
    selectedFilename = filename;
    selectedBasename = basename;
    document.getElementById('selected-filename').textContent = filename;
    const doc = docListCache.find(d => d.filename === filename);
    const extractedText = doc && doc.extracted_text ? doc.extracted_text : '[No extracted text found.]';
    originalTextContent = extractedText;
    document.getElementById('ocr-text').textContent = extractedText;
    
    // Clear any existing search
    clearSearch();
    let flagBtn = document.getElementById('flag-btn');
    let flaggedLabel = document.getElementById('flagged-label');
    flagBtn.style.display = '';
    if (doc && doc.flagged) {
        flagBtn.textContent = 'Unflag';
        flaggedLabel.style.display = '';
    } else {
        flagBtn.textContent = 'Flag for Reprocessing';
        flaggedLabel.style.display = 'none';
    }

    // PDF display logic
    let pdfViewer = document.getElementById('pdf-viewer');
    let pdfMissing = document.getElementById('pdf-missing');
    let pdfPlaceholder = document.getElementById('pdf-placeholder');
    pdfViewer.style.display = "none";
    pdfMissing.style.display = "none";
    pdfPlaceholder.style.display = "none";

    if (filename && filename.toLowerCase().endsWith('.pdf')) {
        console.log('Attempting to fetch PDF:', basename);
        fetch('/api/document/' + encodeURIComponent(basename) + '/pdf', {method: 'HEAD'}).then(resp => {
            if (resp.ok) {
                console.log('PDF found, displaying in iframe.');
                pdfViewer.style.display = '';
                pdfMissing.style.display = 'none';
                pdfPlaceholder.style.display = 'none';
                pdfViewer.src = '/api/document/' + encodeURIComponent(basename) + '/pdf#toolbar=0&navpanes=0';
            } else {
                console.warn('PDF not found on server (HEAD check failed):', basename);
                pdfViewer.style.display = 'none';
                pdfMissing.style.display = '';
                pdfPlaceholder.style.display = 'none';
                pdfViewer.src = '';
            }
        }).catch(e => {
            console.error('Error fetching PDF:', e);
            pdfViewer.style.display = 'none';
            pdfMissing.style.display = '';
            pdfPlaceholder.style.display = 'none';
            pdfViewer.src = '';
        });
    } else {
        pdfViewer.style.display = 'none';
        pdfMissing.style.display = 'none';
        pdfPlaceholder.style.display = '';
        pdfViewer.src = '';
        console.log('Selected file is not a PDF:', filename);
    }
}

document.getElementById('flag-btn').onclick = function() {
    if (!selectedBasename) return;
    const doc = docListCache.find(d => d.basename === selectedBasename);
    const newFlag = !(doc && doc.flagged);
    fetch('/api/document/' + encodeURIComponent(selectedBasename) + '/flag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({flag: newFlag})
    }).then(() => fetchDocuments(false));
};

fetchDocuments(true);

// Resizable top/bottom panels logic
const hResizer = document.getElementById('h-resizer');
const topPanel = document.getElementById('top-panel');
const bottomPanel = document.getElementById('bottom-panel');
let isVertResizing = false;
hResizer.addEventListener('mousedown', function(e) {
    isVertResizing = true;
    document.body.style.cursor = 'row-resize';
});
document.addEventListener('mousemove', function(e) {
    if (!isVertResizing) return;
    const container = document.getElementById('main-vert');
    const rect = container.getBoundingClientRect();
    let offset = e.clientY - rect.top;
    let min = 100, max = rect.height - 100;
    if (offset < min) offset = min;
    if (offset > max) offset = max;
    topPanel.style.height = (offset / rect.height * 100) + '%';
    bottomPanel.style.height = ((rect.height - offset) / rect.height * 100) + '%';
});
document.addEventListener('mouseup', function(e) {
    if (isVertResizing) {
        isVertResizing = false;
        document.body.style.cursor = '';
    }
});

// Search functionality
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function performSearch() {
    const searchInput = document.getElementById('search-input');
    const searchTerm = searchInput.value.trim();
    const ocrTextDiv = document.getElementById('ocr-text');
    const searchStats = document.getElementById('search-stats');
    
    if (!originalTextContent || !searchTerm) {
        // No search term or no text to search
        ocrTextDiv.textContent = originalTextContent || '(none)';
        searchStats.textContent = '';
        return;
    }
    
    // Create case-insensitive regex for search term
    const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(escapedSearchTerm, 'gi');
    
    // Find all matches
    const matches = originalTextContent.match(regex);
    const matchCount = matches ? matches.length : 0;
    
    if (matchCount === 0) {
        ocrTextDiv.textContent = originalTextContent;
        searchStats.textContent = 'No matches found';
        return;
    }
    
    // Escape the original text for safe HTML insertion
    const escapedText = escapeHtml(originalTextContent);
    
    // Highlight matches in the escaped text
    const highlightedText = escapedText.replace(regex, '<span class="search-highlight">$&</span>');
    
    // Update the content with highlighted matches
    ocrTextDiv.innerHTML = highlightedText;
    
    // Update match count
    searchStats.textContent = `${matchCount} match${matchCount !== 1 ? 'es' : ''} found`;
}

function clearSearch() {
    const searchInput = document.getElementById('search-input');
    const ocrTextDiv = document.getElementById('ocr-text');
    const searchStats = document.getElementById('search-stats');
    
    searchInput.value = '';
    ocrTextDiv.textContent = originalTextContent || '(none)';
    searchStats.textContent = '';
}

// Event listeners for search functionality
document.getElementById('search-input').addEventListener('input', performSearch);
document.getElementById('clear-search').addEventListener('click', clearSearch);
</script>
</body>
</html>