<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document OCR Review</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        #doc-list { max-height: 90vh; overflow-y: auto; }
        .doc-entry { cursor: pointer; }
        .doc-entry.selected { background: #e6f7ff; }
        #ocr-text { white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="container-fluid">
    <h2 class="mt-3 mb-4">Document OCR Validation</h2>
    <div class="row">
        <div class="col-md-3">
            <h5>Processed Documents</h5>
            <ul id="doc-list" class="list-group"></ul>
        </div>
        <div class="col-md-9">
            <div id="doc-details" class="mb-4">
                <h5 id="selected-filename">(Select a document)</h5>
                <strong>Extracted Text:</strong>
                <div id="ocr-text" class="border p-2 bg-light" style="min-height:120px;">(none)</div>
                <div class="my-3">
                    <button id="flag-btn" class="btn btn-warning" style="display:none;">Flag for Reprocessing</button>
                    <span id="flagged-label" class="badge bg-danger" style="display:none;">Flagged for Reprocessing</span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
let docListCache = [];
let selectedFilename = null;

function fetchDocuments(selectFirst = false) {
    fetch('/api/documents')
        .then(resp => resp.json())
        .then(docs => {
            docListCache = docs;
            let docList = document.getElementById('doc-list');
            docList.innerHTML = '';
            for (let i = 0; i < docs.length; i++) {
                let doc = docs[i]; // ensure block scope
                let li = document.createElement('li');
                li.className = 'list-group-item doc-entry';
                if (doc.flagged) li.classList.add('list-group-item-danger');
                li.textContent = doc.filename + (doc.flagged ? " (FLAGGED)" : "");
                li.dataset.filename = doc.filename;
                li.onclick = function() {
                    document.querySelectorAll('.doc-entry').forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    loadDocumentDetail(doc.filename);
                };
                docList.appendChild(li);
            }
            if (selectFirst && docs.length > 0) {
                docList.firstChild.click();
            }
        });
}

function loadDocumentDetail(filename) {
    selectedFilename = filename;
    document.getElementById('selected-filename').textContent = filename;
    const doc = docListCache.find(d => d.filename === filename);
    document.getElementById('ocr-text').textContent = doc && doc.extracted_text ? doc.extracted_text : '[No extracted text found.]';
    let flagBtn = document.getElementById('flag-btn');
    let flaggedLabel = document.getElementById('flagged-label');
    flagBtn.style.display = '';
    if (doc && doc.flagged) {
        flagBtn.textContent = 'Unflag';
        flaggedLabel.style.display = '';
    } else {
        flagBtn.textContent = 'Flag for Reprocessing';
        flaggedLabel.style.display = 'none';
    }
}

document.getElementById('flag-btn').onclick = function() {
    if (!selectedFilename) return;
    let isFlag = this.textContent === 'Flag for Reprocessing';
    fetch('/api/document/' + encodeURIComponent(selectedFilename) + '/flag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ flag: isFlag })
    }).then(() => {
        fetchDocuments(selectedFilename);
    });
};

fetchDocuments();
</script>
</body>
</html>
