<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FAX Document Processing Status</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Custom table styling (replacing DataTables due to CDN restrictions) -->
    <style>
        body { background-color: #f8f9fa; }
        .main-content { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            padding: 30px;
            margin: 20px 0;
        }
        .page-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 4px 8px;
        }
        /* Custom styling for table filtering */
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 15px;
        }
        .table-responsive {
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        .table-controls select, .table-controls input {
            max-width: 200px;
        }
        .table th {
            cursor: pointer;
            user-select: none;
        }
        .table th:hover {
            background-color: #495057;
        }
        .table tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
        }
        .navigation-links {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <!-- Navigation Links -->
    <div class="navigation-links">
        <nav>
            <a href="/" class="btn btn-outline-primary btn-sm me-2">← Back to Document Review</a>
            <span class="text-muted">|</span>
            <span class="ms-2 text-muted">FAX Document Processing Status</span>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h2 class="mb-0">
                <i class="bi bi-file-earmark-text"></i>
                FAX Document Processing Status
            </h2>
            <p class="text-muted mb-0 mt-2">View and filter processed document status information</p>
        </div>

        <!-- Status Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-primary" id="total-docs">-</h5>
                        <p class="card-text">Total Documents</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="card-title text-success" id="orientation-corrected">-</h5>
                        <p class="card-text">Orientation Corrected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning" id="flagged-reprocessing">-</h5>
                        <p class="card-text">Flagged for Reprocessing</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title text-info" id="processed-today">-</h5>
                        <p class="card-text">Processed Today</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Controls -->
        <div class="table-controls">
            <div class="d-flex align-items-center gap-2">
                <label for="page-size" class="form-label mb-0">Show:</label>
                <select id="page-size" class="form-select form-select-sm">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="text-muted">entries</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <label for="search-filter" class="form-label mb-0">Filter:</label>
                <input type="text" id="search-filter" class="form-control form-control-sm" placeholder="Search documents...">
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-responsive">
            <table id="fax-status-table" class="table table-striped table-hover" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th onclick="sortTable(0)">Document Name ↕</th>
                        <th onclick="sortTable(1)">Date/Time Received ↕</th>
                        <th onclick="sortTable(2)">Date/Time Processed ↕</th>
                        <th onclick="sortTable(3)">Orientation Changed ↕</th>
                        <th onclick="sortTable(4)">Marked for Reprocessing ↕</th>
                        <th onclick="sortTable(5)">Document Category ↕</th>
                        <th onclick="sortTable(6)">Document Status ↕</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data loaded via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination and Info -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="table-info" class="text-muted">
                Showing 0 to 0 of 0 documents
            </div>
            <nav>
                <ul class="pagination pagination-sm" id="pagination">
                    <!-- Pagination buttons generated by JavaScript -->
                </ul>
            </nav>
        </div>

        <!-- Extension Guidance -->
        <div class="mt-4">
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> Future Enhancement Areas</h6>
                <small>
                    <strong>Document Category:</strong> Currently shows basic document type. 
                    <em>To extend: Implement document classification logic in get_fax_status_documents() function.</em><br>
                    <strong>Document Status:</strong> Currently shows "Processed" for all documents. 
                    <em>To extend: Add status column to database and update logic for different processing states.</em><br>
                    <strong>Date/Time Received:</strong> Currently shows "N/A" as this data isn't tracked. 
                    <em>To extend: Add received_at column to database and update document insertion logic.</em>
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Document data storage
let documentsData = [];
let filteredData = [];
let currentPage = 1;
let pageSize = 25;
let sortColumn = 2; // Default sort by Date/Time Processed
let sortAscending = false;

document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
    
    // Set up event listeners
    document.getElementById('search-filter').addEventListener('input', handleSearch);
    document.getElementById('page-size').addEventListener('change', handlePageSizeChange);
    
    // Auto-refresh every 30 seconds
    setInterval(loadDocuments, 30000);
});

function loadDocuments() {
    fetch('/api/fax_status')
        .then(response => response.json())
        .then(data => {
            documentsData = data;
            applyFiltersAndSort();
            updateStatusCards(data);
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            document.getElementById('table-body').innerHTML = 
                '<tr><td colspan="7" class="text-center text-muted">Error loading document data</td></tr>';
        });
}

function handleSearch() {
    const searchTerm = document.getElementById('search-filter').value.toLowerCase();
    applyFiltersAndSort(searchTerm);
}

function handlePageSizeChange() {
    pageSize = parseInt(document.getElementById('page-size').value);
    currentPage = 1;
    applyFiltersAndSort();
}

function applyFiltersAndSort(searchTerm = '') {
    // Filter data
    if (searchTerm) {
        filteredData = documentsData.filter(doc => 
            Object.values(doc).some(value => 
                String(value).toLowerCase().includes(searchTerm)
            )
        );
    } else {
        filteredData = [...documentsData];
    }
    
    // Sort data
    filteredData.sort((a, b) => {
        const aVal = Object.values(a)[sortColumn] || '';
        const bVal = Object.values(b)[sortColumn] || '';
        
        let comparison = 0;
        if (typeof aVal === 'string' && typeof bVal === 'string') {
            comparison = aVal.localeCompare(bVal);
        } else {
            comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        }
        
        return sortAscending ? comparison : -comparison;
    });
    
    renderTable();
    renderPagination();
    updateTableInfo();
}

function sortTable(columnIndex) {
    if (sortColumn === columnIndex) {
        sortAscending = !sortAscending;
    } else {
        sortColumn = columnIndex;
        sortAscending = true;
    }
    applyFiltersAndSort(document.getElementById('search-filter').value.toLowerCase());
}

function renderTable() {
    const tableBody = document.getElementById('table-body');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredData.length);
    
    if (filteredData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No documents found</td></tr>';
        return;
    }
    
    const rows = [];
    for (let i = startIndex; i < endIndex; i++) {
        const doc = filteredData[i];
        rows.push(`
            <tr>
                <td><strong>${escapeHtml(doc.document_name)}</strong></td>
                <td>${doc.date_received === 'N/A' ? '<span class="text-muted">N/A</span>' : escapeHtml(doc.date_received)}</td>
                <td>${doc.date_processed === 'N/A' ? '<span class="text-muted">N/A</span>' : formatDateTime(doc.date_processed)}</td>
                <td>${doc.orientation_changed === 'Yes' ? '<span class="badge bg-info status-badge">📐 Yes</span>' : '<span class="badge bg-secondary status-badge">No</span>'}</td>
                <td>${doc.marked_reprocessing === 'Yes' ? '<span class="badge bg-warning text-dark status-badge">⚠️ Yes</span>' : '<span class="badge bg-success status-badge">No</span>'}</td>
                <td>${doc.document_category === 'Unclassified' ? '<span class="text-muted fst-italic">' + escapeHtml(doc.document_category) + '</span>' : escapeHtml(doc.document_category)}</td>
                <td><span class="badge bg-primary status-badge">${escapeHtml(doc.document_status)}</span></td>
            </tr>
        `);
    }
    
    tableBody.innerHTML = rows.join('');
}

function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / pageSize);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHtml = '';
    
    // Previous button
    paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
    </li>`;
    
    pagination.innerHTML = paginationHtml;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTable();
        renderPagination();
        updateTableInfo();
    }
    return false; // Prevent link navigation
}

function updateTableInfo() {
    const totalRecords = filteredData.length;
    const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
    const endRecord = Math.min(currentPage * pageSize, totalRecords);
    
    document.getElementById('table-info').textContent = 
        `Showing ${startRecord} to ${endRecord} of ${totalRecords} documents`;
}

function updateStatusCards(data) {
    if (!data || !Array.isArray(data)) return;
    
    const totalDocs = data.length;
    const orientationCorrected = data.filter(doc => doc.orientation_changed === 'Yes').length;
    const flaggedReprocessing = data.filter(doc => doc.marked_reprocessing === 'Yes').length;
    
    // Calculate processed today
    const today = new Date().toDateString();
    const processedToday = data.filter(doc => {
        if (doc.date_processed === 'N/A') return false;
        const processedDate = new Date(doc.date_processed).toDateString();
        return processedDate === today;
    }).length;

    // Update cards
    document.getElementById('total-docs').textContent = totalDocs;
    document.getElementById('orientation-corrected').textContent = orientationCorrected;
    document.getElementById('flagged-reprocessing').textContent = flaggedReprocessing;
    document.getElementById('processed-today').textContent = processedToday;
}

function formatDateTime(dateTimeString) {
    if (!dateTimeString || dateTimeString === 'N/A') return 'N/A';
    try {
        const date = new Date(dateTimeString);
        return date.toLocaleString();
    } catch {
        return dateTimeString;
    }
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}
</script>
</body>
</html>